global
  log /dev/log local0
  log /dev/log local1 notice
  daemon
  maxconn 4096
  stats socket /run/haproxy/admin.sock mode 600 level admin
  user haproxy
  group haproxy

defaults
  log     global
  mode    tcp
  option  tcplog
  option  dontlognull
  timeout connect 10s
  timeout client  1m
  timeout server  1m

frontend kubernetes_api
  bind {{ hostvars[inventory_hostname]['ansible_host'] }}:6443
  default_backend kubernetes_masters

backend kubernetes_masters
  balance roundrobin
  option tcp-check
  default-server inter 3s fall 3 rise 2
{% for host in groups['masters'] %}
  server master-{{ loop.index }} {{ hostvars[host]['ansible_host'] }}:6443{% if enable_api_check %} check{% endif %}
{% endfor %}